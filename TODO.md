# 開発残課題メモ

## 更新日
2026/01/23

---

## 1. 優先度: 高

### 1.1 フローエディタ連携 ✅ ほぼ完了（2026/01/23）
- **説明**: 生成されたフローをビジュアルエディタで編集可能にする
- **必要な作業**:
  - [x] ReactFlowコンポーネントの実装
  - [x] 生成されたフローデータのReactFlow形式への変換
  - [x] ノードのドラッグ&ドロップ機能
  - [x] エッジの追加・削除機能
  - [x] 編集結果のバックエンド保存API（ノード・エッジの個別保存）
  - [x] 手動編集の保持機能（flow_edgesテーブル実装）
  - [ ] 自動レイアウト調整（dagre.js等）※残タスク
- **見積もり**: 1-2日（自動レイアウトのみ）
- **完了内容**: 
  - エッジ保存機能実装（from_node_order/to_node_order方式）
  - リロード後もノードとエッジが復元される
  - フロー再生成時に手動編集が保持される

### 1.2 全体ログ機能
- **説明**: 複数のヒアリングログをマージして全体フローを表示
- **必要な作業**:
  - [ ] ログマージAPIの実装
  - [ ] 重複ノード・エッジの統合ロジック
  - [ ] タイムスタンプベースの並び替え
  - [ ] UI: 全体ログビュー画面
- **見積もり**: 2-3日

### 1.3 エラーハンドリング改善
- **説明**: より詳細なエラーメッセージと自動回復処理
- **必要な作業**:
  - [ ] Claude API エラーの詳細分類
  - [ ] リトライロジックの実装（Exponential Backoff）
  - [ ] ユーザー向けエラーメッセージの多言語対応
  - [ ] フォールバック機能（Claude失敗時のダミーデータ生成）
- **見積もり**: 1-2日

### 1.4 Azure Speech Service移行
- **説明**: Web Speech APIからAzure Speech Serviceへ移行してリアルタイム音声認識の精度向上
- **必要な作業**:
  - [ ] Azure Speech Serviceのアカウント・リソース作成
  - [ ] APIキーと環境変数の設定
  - [ ] フロントエンドでAzure Speech SDKの統合
  - [ ] リアルタイムストリーミング認識の実装
  - [ ] 中間結果（Recognizing）と確定結果（Recognized）の処理分離
  - [ ] 既存のWeb Speech API実装からの切り替え機能
  - [ ] 日本語認識の最適化設定
  - [ ] エラーハンドリングとフォールバック（Web Speech APIへ）
- **見積もり**: 2-3日
- **メリット**: 高精度な日本語認識、ストリーミング対応、専門用語辞書との連携

### 1.5 Azureデプロイ準備
- **説明**: アプリケーション全体をAzureにデプロイするための準備
- **必要な作業**:
  - [ ] Azure App Service / Azure Container Appsの選定
  - [ ] バックエンド（FastAPI）のDockerコンテナ化
  - [ ] フロントエンド（Next.js）のビルド最適化
  - [ ] Azure Database for MySQL（または既存MySQL）への接続設定
  - [ ] 環境変数とシークレット管理（Azure Key Vault）
  - [ ] Azure CDNの設定（静的アセット配信）
  - [ ] デプロイスクリプトの作成（CI/CD）
  - [ ] Azure Monitor / Application Insightsの統合
  - [ ] カスタムドメインとSSL証明書の設定
  - [ ] 本番環境用のセキュリティ設定（CORS、認証、WAF）
- **見積もり**: 4-6日
- **関連リソース**:
  - Azure App Service（バックエンド）
  - Azure Static Web Apps または App Service（フロントエンド）
  - Azure Database for MySQL
  - Azure Speech Service
  - Azure Key Vault
  - Azure Monitor

---

## 2. 優先度: 中

### 2.1 コスト管理機能
- **説明**: API使用量の可視化と予算アラート
- **必要な作業**:
  - [ ] トークン数カウント機能
  - [ ] 使用量の日次/月次集計
  - [ ] 管理画面での使用量グラフ表示
  - [ ] 予算超過時のメール通知
- **見積もり**: 2-3日

### 2.2 音声認識精度向上
- **説明**: 専門用語や固有名詞の認識精度を上げる
- **必要な作業**:
  - [ ] カスタム辞書機能の追加
  - [ ] 業界別ボキャブラリーの準備
  - [ ] 音声認識結果の手動修正UI
  - [ ] 修正データのフィードバックループ
- **見積もり**: 3-4日

### 2.3 テストカバレッジ向上
- **説明**: ユニットテスト・統合テストの追加
- **必要な作業**:
  - [ ] Claude APIのモック実装
  - [ ] フロー生成ロジックのユニットテスト
  - [ ] E2Eテスト（Playwright）
  - [ ] CI/CDパイプラインへの組み込み
- **見積もり**: 3-5日

---

## 3. 優先度: 低（将来的な拡張）

### 3.1 マルチユーザー対応
- **説明**: 複数ユーザーの同時利用とアクセス制御
- **必要な作業**:
  - [ ] 認証・認可システム（JWT）
  - [ ] ユーザー管理画面
  - [ ] プロジェクトの共有機能
  - [ ] ロールベースアクセス制御（RBAC）
- **見積もり**: 5-7日

### 3.2 フローテンプレート機能
- **説明**: よく使うフローパターンをテンプレート化
- **必要な作業**:
  - [ ] テンプレート登録API
  - [ ] テンプレートライブラリUI
  - [ ] テンプレートからの新規フロー作成
  - [ ] コミュニティテンプレートの共有
- **見積もり**: 3-4日

### 3.3 エクスポート機能
- **説明**: フローを各種形式でエクスポート
- **必要な作業**:
  - [ ] PNG/SVG画像出力
  - [ ] PDF出力（日本語フォント対応）
  - [ ] BPMN形式エクスポート
  - [ ] Mermaid記法エクスポート
- **見積もり**: 2-3日

### 3.4 バージョン管理
- **説明**: フローの変更履歴管理
- **必要な作業**:
  - [ ] フローのスナップショット保存
  - [ ] 差分表示機能
  - [ ] 任意のバージョンへのロールバック
  - [ ] ブランチ機能（並行編集）
- **見積もり**: 4-6日

---

## 4. 技術的改善

### 4.1 パフォーマンス最適化
- [ ] Claude APIレスポンスのキャッシュ機構
- [ ] データベースクエリの最適化（インデックス追加）
- [ ] フロントエンドのコード分割（Code Splitting）
- [ ] 画像の遅延読み込み（Lazy Loading）

### 4.2 セキュリティ強化
- [ ] APIキーの暗号化保存
- [ ] CORS設定の厳格化
- [ ] SQLインジェクション対策の再確認
- [ ] XSS対策の追加

### 4.3 ドキュメント整備
- [ ] API仕様書（OpenAPI/Swagger）
- [ ] アーキテクチャ図の作成
- [ ] デプロイ手順書
- [ ] ユーザーマニュアル

### 4.4 Azure関連の技術的改善
- [ ] Azure Application Insightsでのログ・メトリクス収集
- [ ] Azure Front Doorでのグローバル配信最適化
- [ ] Azure CDNでの静的コンテンツキャッシュ
- [ ] Azure Cognitive Servicesの他機能検討（翻訳、テキスト分析）
- [ ] Azure DevOpsでのCI/CDパイプライン構築
- [ ] Azure Cost Managementでのコスト監視設定

---

## 5. 既知の問題

### 5.1 Claude API関連
- **問題**: 長い発言（200文字以上）でタイムアウトが発生
  - **影響度**: 中
  - **暫定対処**: 発言を短く区切るようユーザーに案内
  - **恒久対策**: ストリーミングレスポンスの実装

### 5.2 音声認識関連
- **問題**: 専門用語の誤認識が多い
  - **影響度**: 中
  - **暫定対処**: 手動修正を促す
  - **恒久対策**: カスタム辞書機能の実装（2.2参照）

### 5.3 UI/UX関連
- **問題**: フロープレビューが複雑なフローで見づらい
  - **影響度**: 低
  - **暫定対処**: ズーム機能で対応
  - **恒久対策**: 自動レイアウト調整機能（1.1参照）

### 5.4 フローエディタのエッジ再接続機能
- **問題**: ReactFlow 11.10.4では既存の線（エッジ）を直接ドラッグして別のノードに付け替えることができない
  - **影響度**: 中
  - **現在の動作**: エッジを削除してから新規作成する方式
  - **暫定対処**: ユーザーに「Delete→再作成」の操作フローを案内
  - **恒久対策（候補）**:
    1. **ReactFlowのバージョンアップ**: v11.11以降またはv12以降で`reconnectable`プロパティと再接続イベント（`onReconnect`等）がサポートされている可能性あり
    2. **カスタムエッジタイプの実装**: ReactFlowのカスタムエッジ機能を使い、エッジに独自の再接続ロジックを実装
    3. **ライブラリ変更**: React Flow以外のフローエディタライブラリ（例：react-diagrams）の検討
    4. **手動実装**: エッジのドラッグイベントをフックして、state更新で再接続をシミュレート
  - **推奨アプローチ**: まずReactFlowのバージョンアップを試し、それでも未対応なら2のカスタムエッジ実装を検討
  - **見積もり**: 1-2日（バージョンアップ）、3-4日（カスタム実装）

### 5.5 Azure Speech Service関連
- **問題**: Web Speech APIは専門用語の誤認識が多く、ブラウザ依存
  - **影響度**: 中
  - **暫定対処**: 手動修正を促す
  - **恒久対策**: Azure Speech Serviceへの移行（1.4参照）
  - **見積もり**: 2-3日

---

## 6. Azure移行のロードマップ

### フェーズ1: Azure Speech Service統合（優先）
1. Azure Portalでリソース作成
2. フロントエンドでSDK統合
3. リアルタイムストリーミング実装
4. 動作確認とパフォーマンステスト
- **期間**: 2-3日

### フェーズ2: Azureインフラ準備
1. リソースグループとネットワーク設計
2. Azure Database for MySQLのセットアップ
3. Key Vaultでのシークレット管理
4. 開発環境でのAzure接続テスト
- **期間**: 2-3日

### フェーズ3: アプリケーションのコンテナ化
1. バックエンドのDockerfile作成
2. フロントエンドのビルド最適化
3. docker-compose.ymlの作成
4. ローカルでのコンテナ動作確認
- **期間**: 1-2日

### フェーズ4: Azureデプロイ
1. Azure Container Registry（ACR）へのイメージプッシュ
2. App ServiceまたはContainer Appsへのデプロイ
3. 環境変数とネットワーク設定
4. 本番環境での動作確認
- **期間**: 2-3日

### フェーズ5: 監視とCI/CD
1. Application Insightsの統合
2. GitHub ActionsまたはAzure DevOps設定
3. 自動デプロイパイプライン構築
4. アラート設定とログ監視
- **期間**: 2-3日

**合計見積もり**: 9-14日

---

## 7. 次回ミーティングアジェンダ

1. Azure Speech Service移行の優先度確認
2. Azureデプロイのタイムライン策定
3. コスト見積もりの確認（Azure各種サービス）
4. フローエディタ連携の設計レビュー
5. 全体ログ機能の仕様確定
6. テスト戦略の決定

---

## メモ

- Claude Sonnet 4.5の料金体系を考慮し、開発段階では短いテストを推奨
- 初回$5クレジットで約250-500回のテスト可能
- 本番運用前にコスト管理機能の実装を検討すべき