name: Deploy Backend to Azure App Service (Green Slot)

on:
  push:
    branches: [ feature/realtime-flow-generation_for_deploy ]
    paths: [ 'backend/**' ]
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: 'tech0-gen-11-step3-2-py-71'
  PYTHON_VERSION: '3.11'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      working-directory: backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: List backend directory
      run: |
        echo "=== backend directory contents ==="
        ls -la backend/

    - name: Remove venv and cache before deploy
      run: |
        rm -rf backend/venv
        rm -rf backend/.venv
        rm -rf backend/__pycache__
        find backend -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
        find backend -type f -name "*.pyc" -delete 2>/dev/null || true

    - name: Deploy to Azure Web App (Green Slot)
      uses: azure/webapps-deploy@v2
      id: deploy-to-webapp
      with:
        app-name: 'tech0-gen-11-step3-2-py-71-green-kishimen-deploy'
        publish-profile: ${{ secrets.GREEN_TECH0_GEN_11_STEP3_2_PY_71 }}
        package: backend
